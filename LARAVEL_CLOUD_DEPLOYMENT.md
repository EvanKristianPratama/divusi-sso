# Panduan Deploy Divusi SSO ke Laravel Cloud

## Prasyarat

1. **Akun Laravel Cloud**
   - Daftar di [laravel.cloud](https://laravel.cloud)
   - Login dengan GitHub account

2. **GitHub Repository**
   - Repository sudah tersimpan: `https://github.com/EvanKristianPratama/divusi-sso.git`
   - Akses (public atau private sesuai preferensi)

3. **Firebase Service Account**
   - Download service account JSON dari Firebase Console
   - Siapkan untuk diinput ke environment variables

## Langkah-langkah Deployment

### 1. Akses Laravel Cloud Dashboard

1. Buka [laravel.cloud](https://laravel.cloud)
2. Login dengan GitHub account Anda
3. Klik **"Create New Project"** atau **"New"**

### 2. Connect GitHub Repository

1. Pilih **GitHub** sebagai source
2. Cari dan pilih repository `divusi-sso`
3. Pilih branch: `main`
4. Tentukan **production** dan **staging** branches (jika diperlukan)

### 3. Configure Environments

#### Production Environment

**Basic Settings:**
- **Application Name**: `divusi-sso` (atau nama lain sesuai preferensi)
- **PHP Version**: `8.4` (atau sesuai requirement)
- **Node.js Version**: `20` (untuk Vite assets jika diperlukan)

**Database Configuration:**
- **Database Type**: MySQL 8.0
- Nama database akan otomatis dibuat

**Storage:**
- Pastikan file storage accessible untuk `storage/app/firebase/`

### 4. Set Environment Variables

Masukkan environment variables berikut di Laravel Cloud dashboard (Settings → Environment):

```
APP_NAME=DivusiSSO
APP_ENV=production
APP_DEBUG=false
APP_URL=https://your-domain.com
APP_KEY=<generate dengan: php artisan key:generate>

DB_CONNECTION=mysql
DB_HOST=<Laravel Cloud akan provide>
DB_PORT=3306
DB_DATABASE=<auto-generated>
DB_USERNAME=<auto-generated>
DB_PASSWORD=<auto-generated>

FIREBASE_API_KEY=<dari Firebase Console>
FIREBASE_AUTH_DOMAIN=<project-id>.firebaseapp.com
FIREBASE_PROJECT_ID=<dari Firebase Console>
FIREBASE_STORAGE_BUCKET=<dari Firebase Console>
FIREBASE_MESSAGING_SENDER_ID=<dari Firebase Console>
FIREBASE_APP_ID=<dari Firebase Console>
FIREBASE_CREDENTIALS=/app/storage/app/firebase/service-account.json

SESSION_DRIVER=database
SESSION_LIFETIME=120

CACHE_DRIVER=redis
QUEUE_CONNECTION=redis

MAIL_MAILER=smtp
MAIL_HOST=<mailer config>
MAIL_PORT=587
MAIL_USERNAME=<email>
MAIL_PASSWORD=<password>
MAIL_FROM_ADDRESS=noreply@divusi.com
MAIL_FROM_NAME="Divusi SSO"
```

### 5. Upload Firebase Service Account

**Opsi A: Via Environment Variable (Recommended)**
1. Download service-account.json dari Firebase Console
2. Copy seluruh isi file JSON (jangan tar/compress)
3. Buat environment variable baru: `FIREBASE_SERVICE_ACCOUNT_JSON`
4. Paste seluruh JSON content sebagai value
5. Di `app/Providers/AppServiceProvider.php`, modify untuk read dari env:

```php
$serviceAccountJson = env('FIREBASE_SERVICE_ACCOUNT_JSON');
if ($serviceAccountJson) {
    $factory = Factory::withServiceAccount(json_decode($serviceAccountJson, true));
} else {
    $factory = Factory::withServiceAccount(
        storage_path('app/firebase/service-account.json')
    );
}
$this->app->singleton(FirebaseService::class, function () use ($factory) {
    return new FirebaseService($factory->createAuth());
});
```

**Opsi B: Via File Upload**
1. Gunakan Laravel Cloud's file upload feature atau SSH access
2. Upload service-account.json ke `storage/app/firebase/`
3. Pastikan permissions correct: `644`

### 6. Configure Deployment Settings

1. **Build Steps** (auto-detected atau customize):
   ```bash
   composer install --optimize-autoloader --no-dev
   npm install && npm run build
   ```

2. **Post-Deployment Commands**:
   ```bash
   php artisan migrate --force
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```

3. **Deployment Timeout**: Set minimal 10 menit (untuk migrations besar)

### 7. Configure Custom Domain

1. Di Laravel Cloud dashboard, pilih project → **Domains**
2. Add custom domain: `sso.divusi.com` (atau domain Anda)
3. Update DNS records sesuai instruksi yang diberikan
4. Wait untuk SSL certificate auto-generate (20 menit)

### 8. Redis & Cache Configuration

Laravel Cloud provides Redis instance. Untuk memastikan cache/session berfungsi:

1. **Environment Variables** sudah di-set (CACHE_DRIVER=redis, SESSION_DRIVER=database)
2. Laravel Cloud akan auto-provide `REDIS_URL` dan `REDIS_HOST`
3. Pastikan `.env` di-set untuk connection defaults:

```
REDIS_HOST=<auto from Laravel Cloud>
REDIS_PORT=6379
REDIS_PASSWORD=<auto from Laravel Cloud>
```

### 9. Deploy

1. Klik tombol **Deploy** di Laravel Cloud dashboard
2. Monitor progress di **Deployment Logs**
3. Tunggu hingga status berubah menjadi **Active**

Proses kurang lebih:
- Build: 2-3 menit
- Migrations: 1-2 menit
- Cache warming: 1 menit
- Total: ~5-10 menit

### 10. Post-Deployment Verification

1. **Check Application Health**:
   ```bash
   curl https://your-domain.com
   ```

2. **Verify Login Flow**:
   - Buka https://your-domain.com/login
   - Click "Login with Google"
   - Pastikan redirect dan session berfungsi

3. **Check Database Migrations**:
   - SSH ke Laravel Cloud instance (jika available)
   - `php artisan migrate:status`

4. **Monitor Logs**:
   - Laravel Cloud dashboard → Logs
   - Check untuk errors di `storage/logs/laravel.log`

## Troubleshooting

### Build Failed
- **Cause**: Dependency issues atau PHP version mismatch
- **Solution**: 
  - Check `composer.json` dan `package.json` compatibility
  - Verify PHP version di Laravel Cloud settings

### Database Connection Error
- **Cause**: DB credentials tidak sync
- **Solution**:
  - Verify `DB_HOST`, `DB_USERNAME`, `DB_PASSWORD` di environment
  - Re-generate database credentials di Laravel Cloud dashboard

### Firebase Service Account Not Found
- **Cause**: Path atau file upload failed
- **Solution**:
  - Verify `FIREBASE_CREDENTIALS` path
  - Alternatively, gunakan `FIREBASE_SERVICE_ACCOUNT_JSON` env var method

### Session/Login Not Working
- **Cause**: SESSION_DRIVER atau database not configured
- **Solution**:
  - Verify `SESSION_DRIVER=database` di .env
  - Check migration `create_sessions_table` exists
  - Re-run `php artisan migrate`

### SSL Certificate Not Installing
- **Cause**: DNS not properly propagated
- **Solution**:
  - Wait 1-2 hours untuk DNS propagation
  - Verify DNS records at dnschecker.org
  - Check Laravel Cloud domain settings

## Auto-Deploy dari GitHub (Optional)

1. Di Laravel Cloud, enable **Auto-Deploy**
2. Setiap push ke branch `main` akan auto-trigger deployment
3. Monitoring bisa dilakukan di dashboard realtime

## Rollback (Jika Perlu)

1. Di Laravel Cloud dashboard → Deployments
2. Pilih deployment sebelumnya yang successful
3. Klik **Rollback**
4. Confirm

## Skalabilitas Ke Depan

- **Tambah Workers**: Laravel Cloud bisa auto-scale berdasarkan traffic
- **Database**: Upgrade MySQL plan jika diperlukan storage lebih besar
- **Redis**: Upgrade jika cache hit rate menurun
- **Storage**: Configure S3 integration untuk file uploads

## Support & Dokumentasi

- **Laravel Cloud Docs**: https://docs.laravel.cloud
- **Community Forum**: https://laracasts.com (Laravel Cloud section)
- **Status Page**: https://status.laravel.cloud

---

**Catatan Penting untuk Divusi SSO:**
- Pastikan Firebase Console sudah whitelist domain production untuk OAuth callbacks
- Untuk integrasi SSO dengan apps lain (COBIT, PMO), update redirect URLs mereka ke domain production
- Jangan lupa rotate/regenerate service-account.json di Firebase setelah upload ke production
